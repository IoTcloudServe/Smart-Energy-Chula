<!--File: cubems_fetch1888.html

Class: 2102541 IoT Fundamentals
Department of Electrical Engineering
Faculty of Engineering, Chulalongkorn University

Code Purpose:

To demo IEEE1888-fetch on CU-BEMS. The code is written to optimise its readability.
To use it for a production scale, an additional work is required especially on uses
of 'cursur' to flow-control IEEE1888-fetch in requested data batches of proper size.

Ver 0.1 Written by: Dr C Aswakul (8 Feb 2019)
        Updated by : SKK
-->

<html>

<head>
    <title>CU-BEMS Testbed, Department of Electrical Engineering,
        Faculty of Engineering, Chulalogkorn University</title>

    <script src="https://cdn.netpie.io/microgear.js"></script>

    <script type="text/javascript">

        function entered_data() {
            var pointID1 = document.getElementById('PointID1').value.trim();
            //alert(pointID1 + "a");
            var pointID2 = document.getElementById('PointID2').value.trim();
            var APPID = document.getElementById('AppID').value.trim();
            var KEY = document.getElementById('Key').value.trim();
            var SECRET = document.getElementById('Secret').value.trim();
            return [pointID1, pointID2, APPID, KEY, SECRET];
        }

        var keyIDSet;
        var microgear_;
        var req = setInterval(Fetching, 15000);

        function IsConnected() {
            keyIDSet = '';
            var keyObject = entered_data().slice(0, 2);
            //windows.alert(keyObject);
            var noA = keyObject.length;
            //'<key id="bems.ee.eng.chula.ac.th/energy_consumption/department" attrName="time" select="maximum"></key> '
            //'<key id="bems.ee.eng.chula.ac.th/ee_health_pad/renewable_energy" attrName="time" select="maximum"></key> '
            for (var j = 0; j < noA; j++) { keyIDSet += '<key id="' + keyObject[j] + '" attrName="time" select="maximum"></key> '; }
            microgear_ = Microgear.create({ key : entered_data()[3], secret : entered_data()[4] });
            //microgear_.useTLS(false);
            //window.alert(typeof keyIDSet);
            //window.alert(keyIDSet);
            microgear_.on('connected', function () {
                window.alert("connected");
                microgear_.subscribe("/CUBEMS/ReturnData");
            });
            //microgear_.publish("/CUBEMS/FetchData", keyIDSet);

            microgear_.on('message', function (topic, msg) {
                document.getElementById("fetched_data").innerHTML = msg;
                //window.alert("received");
            });
            //window.alert("published");
            //microgear_.subscribe("/CUBEMS/ReturnData");
            microgear_.connect(entered_data()[2]);            
        }

        function Fetching(){
            microgear_.publish("/CUBEMS/FetchData", keyIDSet);
        }

        function DisConnected() {
            clearInterval(req);
        }


    </script>

</head>

<body>

    <h1> </h1>

    <h2> To fetch Data from CU-BEMS, please contact us via the following email: </h2>
    <h2> Then we will send back the username and password </h2>
    <h2> After receiving the username and password, please enter point URLs: </h2>

    <h4> To get the latest value, just copy two of the following URLs and then paste on the 'Point ID #1' and 'Point ID
        #2' boxes respectively </h4>
    <!--<p>
    &lt;key id="bems.ee.eng.chula.ac.th/energy_consumption/department"
     attrName="time" select="maximum">&lt;/key>
    </p>-->

    <p> bems.ee.eng.chula.ac.th/ee_health_pad/co2_reduction </p>
    <p> bems.ee.eng.chula.ac.th/energy_consumption/department </p>
    <p> bems.ee.eng.chula.ac.th/ee_health_pad/consumption </p>
    <p> bems.ee.eng.chula.ac.th/ee_health_pad/electricity_saved </p>
    <p> bems.ee.eng.chula.ac.th/ee_health_pad/renewable_energy </p>

    <!--<h4> To get the values collected in a time interval ... </h4>-->
    <!--<p>    
    &lt;key id="bems.ee.eng.chula.ac.th/energy_consumption/department"
     attrName="time" gteq="2019-01-31T00:00:00+07:00"
     lt="2019-01-31T00:10:00+07:00">&lt;/key>
    </p>-->


    Point ID #1 : <input type="text" size=180 id="PointID1"> <br><br>
    <console class="log"></console>
    Point ID #2 : <input type="text" size=180 id="PointID2"> <br><br>
    APP ID : <input type="text" size=180 id="AppID"> <br><br>
    KEY : <input type="text" size=180 id="Key"> <br><br>
    SECRET : <input type="text" size=180 id="Secret"> <br><br>
    <input type="button" value="Start FETCH" onclick="IsConnected()" />
    <input type="button" value="Stop Fetch" onclick="DisConnected()" />

    <h2> Fetched result:</h2>
    <textarea rows="10" cols="150" style="border:none;" id="fetched_data">
	</textarea>

</body>

</html>